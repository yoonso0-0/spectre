<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - 102d152bb208d020115bc267fd9f132d57025466 - /work/build/docs/xml/observers_infrastructure_dev_guide.xml</title>
  <link rel="stylesheet" type="text/css" href="../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title"> SpECTRE Documentation Coverage Report</td></tr>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../index.html">top level</a> - <a href="index.html">work/build/docs/xml</a> - observers_infrastructure_dev_guide.xml</td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
             <td class="headerItem">Commit:</td>
             <td class="headerValue"><a target="_blank" href="https://github.com/sxs-collaboration/spectre/commit/102d152bb208d020115bc267fd9f132d57025466">102d152bb208d020115bc267fd9f132d57025466</a></td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2021-01-05 20:09:09</td>
            <td></td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span><span class="lineCov">          1 : &lt;?xml version='1.0' encoding='UTF-8' standalone='no'?&gt;</span></a>
<a name="2"><span class="lineNum">       2 </span>            : &lt;doxygen xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;compound.xsd&quot; version=&quot;1.8.17&quot;&gt;</a>
<a name="3"><span class="lineNum">       3 </span>            :   &lt;compounddef id=&quot;observers_infrastructure_dev_guide&quot; kind=&quot;page&quot;&gt;</a>
<a name="4"><span class="lineNum">       4 </span>            :     &lt;compoundname&gt;observers_infrastructure_dev_guide&lt;/compoundname&gt;</a>
<a name="5"><span class="lineNum">       5 </span>            :     &lt;title&gt;Observers Infrastructure&lt;/title&gt;</a>
<a name="6"><span class="lineNum">       6 </span>            :     &lt;briefdescription&gt;</a>
<a name="7"><span class="lineNum">       7 </span>            :     &lt;/briefdescription&gt;</a>
<a name="8"><span class="lineNum">       8 </span>            :     &lt;detaileddescription&gt;</a>
<a name="9"><span class="lineNum">       9 </span>            : &lt;para&gt;The observers infrastructure works with two parallel components: a group and a nodegroup. We have two types of observations: &lt;computeroutput&gt;Reduction&lt;/computeroutput&gt; and &lt;computeroutput&gt;Volume&lt;/computeroutput&gt; (see the enum &lt;computeroutput&gt;observers::TypeOfObservation&lt;/computeroutput&gt;). &lt;computeroutput&gt;Reduction&lt;/computeroutput&gt; data is anything that is written once per time/integral identifier per simulation. Some examples of reduction data are integrals or L2 norms over the entire domain, integrals or L2 norms over part of the domain, and integrals over lower-dimensional surfaces such as apparent horizons or slices through the domain. Volume data is anything that has physical extent, such as any of the evolved variables (or derived quantities thereof) across all or part of the domain, or quantities on lower-dimensional surfaces in the domain (e.g. the rest mass density in the xy-plane). Reduction and volume data both use the group and nodegroup for actually getting the data to disk, but do so in a slightly different manner.&lt;/para&gt;</a>
<a name="10"><span class="lineNum">      10 </span>            : &lt;sect2 id=&quot;observers_infrastructure_dev_guide_1autotoc_md86&quot;&gt;</a>
<a name="11"><span class="lineNum">      11 </span>            : &lt;title&gt;Reduction Data&lt;/title&gt;</a>
<a name="12"><span class="lineNum">      12 </span>            : &lt;para&gt;Reduction data requires combining information from many or all cores of a supercomputer to get a single value. Reductions are tagged by some temporal value, which for hyperbolic systems is the time and for elliptic systems some combination of linear and non-linear iteration count. The reduction data is stored in an object of type &lt;computeroutput&gt;Parallel::ReductionData&lt;/computeroutput&gt;, which takes as template parameters a series of &lt;computeroutput&gt;&lt;ref refid=&quot;structParallel_1_1ReductionDatum&quot; kindref=&quot;compound&quot;&gt;Parallel::ReductionDatum&lt;/ref&gt;&lt;/computeroutput&gt;. A &lt;computeroutput&gt;&lt;ref refid=&quot;structParallel_1_1ReductionDatum&quot; kindref=&quot;compound&quot;&gt;Parallel::ReductionDatum&lt;/ref&gt;&lt;/computeroutput&gt; takes as template parameters the type of the data and operators that define how data from the different cores are to be combined to a single value. See the paragraphs below for more detail, and the documentation of &lt;computeroutput&gt;&lt;ref refid=&quot;structParallel_1_1ReductionDatum&quot; kindref=&quot;compound&quot;&gt;Parallel::ReductionDatum&lt;/ref&gt;&lt;/computeroutput&gt; for examples.&lt;/para&gt;</a>
<a name="13"><span class="lineNum">      13 </span>            : &lt;para&gt;At the start of a simulation, every component and event that wants to perform a reduction for observation, or will be part of a reduction observation, must register with the &lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1Observer&quot; kindref=&quot;compound&quot;&gt;observers::Observer&lt;/ref&gt;&lt;/computeroutput&gt; component. The &lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1Observer&quot; kindref=&quot;compound&quot;&gt;observers::Observer&lt;/ref&gt;&lt;/computeroutput&gt; is a group, which means there is one per core. The registration is used so that the &lt;computeroutput&gt;Observer&lt;/computeroutput&gt; knows once all data for a specific reduction (both in time and by name/ID) has been contributed. Reduction data is combined on each core as it is contributed by using the binary operator from &lt;computeroutput&gt;&lt;ref refid=&quot;structParallel_1_1ReductionDatum&quot; kindref=&quot;compound&quot;&gt;Parallel::ReductionDatum&lt;/ref&gt;&lt;/computeroutput&gt;&amp;apos;s second template parameter. Once all the data is collected on the core, it is copied to the local &lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1ObserverWriter&quot; kindref=&quot;compound&quot;&gt;observers::ObserverWriter&lt;/ref&gt;&lt;/computeroutput&gt; nodegroup, which keeps track of how many of the cores on the node will be contributing to a specific observation, and again combines all the data as it is being contributed. Once all the node&amp;apos;s data is collected to the nodegroup, the data is sent to node &lt;computeroutput&gt;0&lt;/computeroutput&gt; which combines the reduction data as it arrives using the binary operator from &lt;computeroutput&gt;&lt;ref refid=&quot;structParallel_1_1ReductionDatum&quot; kindref=&quot;compound&quot;&gt;Parallel::ReductionDatum&lt;/ref&gt;&lt;/computeroutput&gt;&amp;apos;s second template parameter. Using node &lt;computeroutput&gt;0&lt;/computeroutput&gt; for collecting the final reduction data is an arbitrary choice, but we are always guaranteed to have a node &lt;computeroutput&gt;0&lt;/computeroutput&gt;.&lt;/para&gt;</a>
<a name="14"><span class="lineNum">      14 </span>            : &lt;para&gt;Once all the reductions are received on node &lt;computeroutput&gt;0&lt;/computeroutput&gt;, the &lt;computeroutput&gt;ObserverWriter&lt;/computeroutput&gt; invokes the &lt;computeroutput&gt;InvokeFinal&lt;/computeroutput&gt; (third) template parameter on each &lt;computeroutput&gt;&lt;ref refid=&quot;structParallel_1_1ReductionDatum&quot; kindref=&quot;compound&quot;&gt;Parallel::ReductionDatum&lt;/ref&gt;&lt;/computeroutput&gt; (this is the n-ary) in order to finalize the data before writing. This is used, for example, for dividing by the total number of grid points in an L1 or L2 norm. The reduction data is then written to an HDF5 file whose name is set in the input file using the option &lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1Tags_1_1ReductionFileName&quot; kindref=&quot;compound&quot;&gt;observers::Tags::ReductionFileName&lt;/ref&gt;&lt;/computeroutput&gt;. Specifically, the data is written into an &lt;computeroutput&gt;&lt;ref refid=&quot;classh5_1_1Dat&quot; kindref=&quot;compound&quot;&gt;h5::Dat&lt;/ref&gt;&lt;/computeroutput&gt; subfile since, along with the data, the subfile name must be passed through the reductions.&lt;/para&gt;</a>
<a name="15"><span class="lineNum">      15 </span>            : &lt;para&gt;The actions used for registering reductions are &lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1Actions_1_1RegisterEventsWithObservers&quot; kindref=&quot;compound&quot;&gt;observers::Actions::RegisterEventsWithObservers&lt;/ref&gt;&lt;/computeroutput&gt;, &lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1Actions_1_1RegisterSingletonWithObserverWriter&quot; kindref=&quot;compound&quot;&gt;observers::Actions::RegisterSingletonWithObserverWriter&lt;/ref&gt;&lt;/computeroutput&gt;, and &lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1Actions_1_1RegisterWithObservers&quot; kindref=&quot;compound&quot;&gt;observers::Actions::RegisterWithObservers&lt;/ref&gt;&lt;/computeroutput&gt;. There is a separate &lt;computeroutput&gt;&lt;ref refid=&quot;namespaceRegistration&quot; kindref=&quot;compound&quot;&gt;Registration&lt;/ref&gt;&lt;/computeroutput&gt; phase at the beginning of all simulations where everything must register with the observers. The action &lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1Actions_1_1ContributeReductionData&quot; kindref=&quot;compound&quot;&gt;observers::Actions::ContributeReductionData&lt;/ref&gt;&lt;/computeroutput&gt; is used to send data to the &lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1Observer&quot; kindref=&quot;compound&quot;&gt;observers::Observer&lt;/ref&gt;&lt;/computeroutput&gt; component in the case where there is a reduction done across an array or subset of an array. If a singleton parallel component needs to write data directly to disk it should use the &lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1ThreadedActions_1_1WriteReductionData&quot; kindref=&quot;compound&quot;&gt;observers::ThreadedActions::WriteReductionData&lt;/ref&gt;&lt;/computeroutput&gt; action called on the zeroth element of the &lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1ObserverWriter&quot; kindref=&quot;compound&quot;&gt;observers::ObserverWriter&lt;/ref&gt;&lt;/computeroutput&gt; component.&lt;/para&gt;</a>
<a name="16"><span class="lineNum">      16 </span>            : &lt;/sect2&gt;</a>
<a name="17"><span class="lineNum">      17 </span>            : &lt;sect2 id=&quot;observers_infrastructure_dev_guide_1autotoc_md87&quot;&gt;</a>
<a name="18"><span class="lineNum">      18 </span>            : &lt;title&gt;Volume Data&lt;/title&gt;</a>
<a name="19"><span class="lineNum">      19 </span>            : &lt;para&gt;Volume data is vaguely defined as anything that has some extent. For example, in a 3d simulation, data on 2d surfaces is still considered volume data for the purposes of observing data. The spectral coefficients can also be written as volume data, though some care must be taken in that case to correctly identify which mode is associated with which terms in the basis function expansion. Whatever component will contribute volume data to be written must register with the &lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1Observer&quot; kindref=&quot;compound&quot;&gt;observers::Observer&lt;/ref&gt;&lt;/computeroutput&gt; component (there currently isn&amp;apos;t tested support for directly registering with the &lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1ObserverWriter&quot; kindref=&quot;compound&quot;&gt;observers::ObserverWriter&lt;/ref&gt;&lt;/computeroutput&gt;). This registration is the same as in the reduction data case.&lt;/para&gt;</a>
<a name="20"><span class="lineNum">      20 </span>            : &lt;para&gt;Once the observers are registered, data is contributed to the &lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1Observer&quot; kindref=&quot;compound&quot;&gt;observers::Observer&lt;/ref&gt;&lt;/computeroutput&gt; component using the &lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1Actions_1_1ContributeVolumeData&quot; kindref=&quot;compound&quot;&gt;observers::Actions::ContributeVolumeData&lt;/ref&gt;&lt;/computeroutput&gt; action. The data is packed into a &lt;computeroutput&gt;&lt;ref refid=&quot;cpp/container/vector&quot; kindref=&quot;compound&quot; external=&quot;/__w/spectre/spectre/docs/config/cppreference-doxygen-web.tag.xml&quot;&gt;std::vector&lt;/ref&gt;&amp;lt;&lt;ref refid=&quot;structTensorComponent&quot; kindref=&quot;compound&quot;&gt;TensorComponent&lt;/ref&gt;&amp;gt;&lt;/computeroutput&gt;, where the &lt;computeroutput&gt;&lt;ref refid=&quot;structTensorComponent&quot; kindref=&quot;compound&quot;&gt;TensorComponent&lt;/ref&gt;&lt;/computeroutput&gt; is data from just one tensor component or a reduction over a tensor. The &lt;computeroutput&gt;extents&lt;/computeroutput&gt;, &lt;computeroutput&gt;&lt;ref refid=&quot;group__SpectralGroup_1ga37c9c17d05dccca652060d117f72ee21&quot; kindref=&quot;member&quot;&gt;Spectral::Basis&lt;/ref&gt;&lt;/computeroutput&gt; and &lt;computeroutput&gt;&lt;ref refid=&quot;group__SpectralGroup_1ga7744e520f6d553caf358a6f09f5978c1&quot; kindref=&quot;member&quot;&gt;Spectral::Quadrature&lt;/ref&gt;&lt;/computeroutput&gt; are currently also passed to the &lt;computeroutput&gt;ContributeVolumeData&lt;/computeroutput&gt; action. Once all the elements on a single core have contributed their volume data to the &lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1Observer&quot; kindref=&quot;compound&quot;&gt;observers::Observer&lt;/ref&gt;&lt;/computeroutput&gt; group, the &lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1Observer&quot; kindref=&quot;compound&quot;&gt;observers::Observer&lt;/ref&gt;&lt;/computeroutput&gt; group moves its data to the &lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1ObserverWriter&quot; kindref=&quot;compound&quot;&gt;observers::ObserverWriter&lt;/ref&gt;&lt;/computeroutput&gt; component to be written. We write one file per node, appending the node ID to the HDF5 file name to distinguish between files written by different nodes. The HDF5 file name is specified in the input file using the &lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1Tags_1_1VolumeFileName&quot; kindref=&quot;compound&quot;&gt;observers::Tags::VolumeFileName&lt;/ref&gt;&lt;/computeroutput&gt; option. The data is written into a subfile of the HDF5 file using the &lt;computeroutput&gt;h5::VolumeFile&lt;/computeroutput&gt; class.&lt;/para&gt;</a>
<a name="21"><span class="lineNum">      21 </span>            : &lt;/sect2&gt;</a>
<a name="22"><span class="lineNum">      22 </span>            : &lt;sect2 id=&quot;observers_infrastructure_dev_guide_1autotoc_md88&quot;&gt;</a>
<a name="23"><span class="lineNum">      23 </span>            : &lt;title&gt;Threading and NodeLocks&lt;/title&gt;</a>
<a name="24"><span class="lineNum">      24 </span>            : &lt;para&gt;Since the &lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1ObserverWriter&quot; kindref=&quot;compound&quot;&gt;observers::ObserverWriter&lt;/ref&gt;&lt;/computeroutput&gt; class is a nodegroup, its entry methods can be invoked simultaneously on different cores of the node. However, this can lead to race conditions if care isn&amp;apos;t taken. The biggest caution is that the &lt;computeroutput&gt;DataBox&lt;/computeroutput&gt; cannot be mutated on one core and simultaneously accessed on another. This is because in order to guarantee a reasonable state for data in the &lt;computeroutput&gt;DataBox&lt;/computeroutput&gt;, it must be impossible to perform a &lt;computeroutput&gt;&lt;ref refid=&quot;group__DataBoxGroup_1gae08744824ea7df89224f128b2080c5b1&quot; kindref=&quot;member&quot;&gt;db::get&lt;/ref&gt;&lt;/computeroutput&gt; on a &lt;computeroutput&gt;DataBox&lt;/computeroutput&gt; from inside or while a &lt;computeroutput&gt;&lt;ref refid=&quot;group__DataBoxGroup_1ga258d81b1a545746fb8e039349da6baae&quot; kindref=&quot;member&quot;&gt;db::mutate&lt;/ref&gt;&lt;/computeroutput&gt; is being done. What this means in practice is that all entry methods on a nodegroup must put their &lt;computeroutput&gt;DataBox&lt;/computeroutput&gt; accesses inside of a &lt;computeroutput&gt;node_lock.lock()&lt;/computeroutput&gt; and &lt;computeroutput&gt;node_lock.unlock()&lt;/computeroutput&gt; block. To achieve better parallel performance and threading, the amount of work done while the entire node is locked should be minimized. To this end, we have additional locks. One for the HDF5 files because we do not require a threadsafe HDF5 (&lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1Tags_1_1H5FileLock&quot; kindref=&quot;compound&quot;&gt;observers::Tags::H5FileLock&lt;/ref&gt;&lt;/computeroutput&gt;). We also have locks for the objects mutated when contributing reduction data (&lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1Tags_1_1ReductionDataLock&quot; kindref=&quot;compound&quot;&gt;observers::Tags::ReductionDataLock&lt;/ref&gt;&lt;/computeroutput&gt;) and the objects mutated when contributing volume data (&lt;computeroutput&gt;&lt;ref refid=&quot;structobservers_1_1Tags_1_1VolumeDataLock&quot; kindref=&quot;compound&quot;&gt;observers::Tags::VolumeDataLock&lt;/ref&gt;&lt;/computeroutput&gt;).&lt;/para&gt;</a>
<a name="25"><span class="lineNum">      25 </span>            : &lt;/sect2&gt;</a>
<a name="26"><span class="lineNum">      26 </span>            : &lt;sect2 id=&quot;observers_infrastructure_dev_guide_1autotoc_md89&quot;&gt;</a>
<a name="27"><span class="lineNum">      27 </span>            : &lt;title&gt;Future changes&lt;/title&gt;</a>
<a name="28"><span class="lineNum">      28 </span>            : &lt;para&gt;&lt;itemizedlist&gt;</a>
<a name="29"><span class="lineNum">      29 </span>            : &lt;listitem&gt;&lt;para&gt;It would be preferable to make the &lt;computeroutput&gt;Observer&lt;/computeroutput&gt; and &lt;computeroutput&gt;ObserverWriter&lt;/computeroutput&gt; parallel components more general and have them act as the core (node)group. Since any simple actions can be run on them, it should be possible to use them for most, if not all cases where we need a (node)group. &lt;/para&gt;</a>
<a name="30"><span class="lineNum">      30 </span>            : &lt;/listitem&gt;&lt;/itemizedlist&gt;</a>
<a name="31"><span class="lineNum">      31 </span>            : &lt;/para&gt;</a>
<a name="32"><span class="lineNum">      32 </span>            : &lt;/sect2&gt;</a>
<a name="33"><span class="lineNum">      33 </span>            :     &lt;/detaileddescription&gt;</a>
<a name="34"><span class="lineNum">      34 </span>            :   &lt;/compounddef&gt;</a>
<a name="35"><span class="lineNum">      35 </span>            : &lt;/doxygen&gt;</a>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.14</a></td></tr>
  </table>
  <br>

</body>
</html>
